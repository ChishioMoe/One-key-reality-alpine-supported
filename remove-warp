#!/bin/bash

# ====================================================
# 1. 环境预检与依赖安装
# ====================================================

# 只有在 bash 环境下才能运行本脚本 (处理 Alpine 默认 sh 的问题)
if [ -z "$BASH_VERSION" ]; then
    if [ -f /etc/alpine-release ] && ! command -v bash >/dev/null 2>&1; then
        echo "检测到 Alpine 系统，正在安装 bash 以继续..."
        apk update && apk add bash
    fi
    exec bash "$0" "$@"
fi

# 核心依赖安装函数
install_deps() {
    if [ -f /etc/alpine-release ]; then
        echo "正在配置 Alpine Linux 环境..."
        apk update
        apk add --no-cache bash curl wget sudo jq qrencode net-tools lsof coreutils grep gawk sed tzdata
    elif [ -f /etc/debian_version ]; then
        echo "正在配置 Debian/Ubuntu 环境..."
        apt-get update
        apt-get -y install curl wget sudo jq qrencode net-tools lsof coreutils -qq
    fi
}

install_deps

# ====================================================
# 2. 基础设置与颜色
# ====================================================
sleep 1
echo -e "                     _ ___                   \n ___ ___ __ __ ___ _| |  _|___ __ __   _ ___ \n|-_ |_  |  |  |-_ | _ |   |- _|  |  |_| |_  |\n|___|___|  _  |___|___|_|_|___|  _  |___|___|\n        |_____|               |_____|        "

red='\e[91m'
green='\e[92m'
yellow='\e[93m'
magenta='\e[95m'
cyan='\e[96m'
none='\e[0m'

error() { echo -e "\n$red 输入错误! $none\n"; }
warn() { echo -e "\n$yellow $1 $none\n"; }
pause() {
    read -rsp "$(echo -e "按 $green Enter 回车键 $none 继续....或按 $red Ctrl + C $none 取消.")" -d $'\n'
    echo
}

# 服务重启函数 (兼容两种 init 系统)
restart_xray() {
    echo -e "$yellow正在重启 Xray 服务...$none"
    if command -v systemctl >/dev/null 2>&1; then
        systemctl restart xray
    elif command -v rc-service >/dev/null 2>&1; then
        rc-service xray restart
    else
        service xray restart
    fi
}

# ====================================================
# 3. 网络信息获取
# ====================================================
InFaces=($(ls /sys/class/net/ | grep -E '^(eth|ens|eno|esp|enp|venet|vif|eth0)'))

for i in "${InFaces[@]}"; do
    Public_IPv4=$(curl -4s --interface "$i" -m 2 https://www.cloudflare.com/cdn-cgi/trace | awk -F= '/ip=/{print $2}')
    Public_IPv6=$(curl -6s --interface "$i" -m 2 https://www.cloudflare.com/cdn-cgi/trace | awk -F= '/ip=/{print $2}')
    [[ -n "$Public_IPv4" ]] && IPv4="$Public_IPv4"
    [[ -n "$Public_IPv6" ]] && IPv6="$Public_IPv6"
done

# 时区获取
if command -v timedatectl >/dev/null 2>&1; then
    timezone=$(timedatectl | awk '/Time zone/ {print $3}')
else
    timezone=$(cat /etc/timezone 2>/dev/null || date +%Z)
fi

uuidSeed=${IPv4}${IPv6}$(cat /proc/sys/kernel/hostname)${timezone}
default_uuid=$(curl -sL "https://www.uuidtools.com/api/generate/v3/namespace/ns:dns/name/${uuidSeed}" | grep -oE '[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}' | head -n 1)

# 参数化执行逻辑
if [ $# -ge 1 ]; then
    case ${1} in
    4) netstack=4; ip=${IPv4} ;;
    6) netstack=6; ip=${IPv6} ;;
    *) 
        if [[ -n "$IPv4" ]]; then netstack=4; ip=${IPv4};
        elif [[ -n "$IPv6" ]]; then netstack=6; ip=${IPv6};
        else warn "没有获取到公共IP"; fi ;;
    esac
    port=${2:-443}; domain=${3:-"learn.microsoft.com"}; uuid=${4:-$default_uuid}
fi

pause

# ====================================================
# 4. 安装与环境修复 (修复版)
# ====================================================
echo -e "${yellow}检查并安装 Xray...$none"

# 定义绝对路径，防止找不到命令
XRAY_BIN="/usr/local/bin/xray"
CONFIG_DIR="/usr/local/etc/xray"
LOG_DIR="/var/log/xray"

# 强制重新安装 (使用官方脚本，但增加后续修复)
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install --version v25.10.15
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install-geodata

# 修复 1: 确保二进制文件可执行
chmod +x $XRAY_BIN 2>/dev/null

# 修复 2: 确保目录存在 (解决 config.json 报错核心)
mkdir -p $CONFIG_DIR
mkdir -p $LOG_DIR
touch $LOG_DIR/access.log $LOG_DIR/error.log
chown -R nobody:nobody $LOG_DIR 2>/dev/null || true 

# 修复 3: 手动补全 Alpine 的 OpenRC 服务文件 (如果官方脚本安装失败)
if [ ! -f /etc/init.d/xray ] && [ -f /etc/alpine-release ]; then
    echo -e "${yellow}检测到 OpenRC 服务文件缺失，正在手动修复...$none"
    cat > /etc/init.d/xray <<-EOF
#!/sbin/openrc-run

name="Xray"
description="Xray Service"
command="/usr/local/bin/xray"
command_args="run -c /usr/local/etc/xray/config.json"
pidfile="/run/xray.pid"
command_background=true

depend() {
    need net
    after firewall
}
EOF
    chmod +x /etc/init.d/xray
    rc-update add xray default
fi

# ====================================================
# 5. 交互式配置 (接续)
# ====================================================

# ... (网络栈选择部分保持不变，此处省略，假设变量已存在) ...
# 如果上面变量丢失，请保留你原脚本的交互部分，这里只修正下面的密钥生成

# Reality 密钥生成 (修复版：使用绝对路径，去除不稳定的 xargs 管道)
echo -e "${yellow}正在生成 Reality 密钥...$none"

# 这里的逻辑改为直接生成新密钥，不再依赖 UUID 种子 (UUID 种子法在不同环境极不稳定)
# 必须使用绝对路径调用 xray
if [ -f "$XRAY_BIN" ]; then
    key_output=$($XRAY_BIN x25519)
    private_key=$(echo "$key_output" | grep "Private key:" | awk '{print $3}')
    public_key=$(echo "$key_output" | grep "Public key:" | awk '{print $3}')
    shortid=$(openssl rand -hex 8) # 生成随机 shortId
else
    echo -e "${red}致命错误：找不到 Xray 二进制文件 ($XRAY_BIN)。安装可能失败。$none"
    exit 1
fi

# 目标网站 (SNI)
if [[ -z $domain ]]; then
    read -p "$(echo -e "请输入目标网站 SNI (默认: ${cyan}learn.microsoft.com$none): ")" domain
    domain=${domain:-"learn.microsoft.com"}
fi

# ====================================================
# 6. 写入配置文件 (修复版)
# ====================================================
echo -e "${yellow}正在写入配置文件...$none"

cat > $CONFIG_DIR/config.json <<-EOF
{
  "log": { "access": "$LOG_DIR/access.log", "error": "$LOG_DIR/error.log", "loglevel": "warning" },
  "inbounds": [{
      "listen": "0.0.0.0",
      "port": ${port},
      "protocol": "vless",
      "settings": {
        "clients": [{ "id": "${uuid}", "flow": "xtls-rprx-vision" }],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "${domain}:443",
          "xver": 0,
          "serverNames": ["${domain}"],
          "privateKey": "${private_key}",
          "shortIds": ["${shortid}"]
        }
      },
      "sniffing": { "enabled": true, "destOverride": ["http", "tls", "quic"] }
  }],
  "outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "freedom", "settings": { "domainStrategy": "UseIPv4" }, "tag": "force-ipv4" },
    { "protocol": "freedom", "settings": { "domainStrategy": "UseIPv6" }, "tag": "force-ipv6" },
    { "protocol": "blackhole", "tag": "block" }
  ],
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [ { "type": "field", "ip": ["geoip:private"], "outboundTag": "block" } ]
  }
}
EOF

# 重启服务
echo -e "$yellow正在启动 Xray 服务...$none"
if command -v rc-service >/dev/null 2>&1; then
    rc-service xray restart
else
    # 暴力启动兜底
    pkill -x xray
    nohup $XRAY_BIN run -c $CONFIG_DIR/config.json >/dev/null 2>&1 &
    echo "使用 nohup 后台启动 (非服务模式)"
fi

# ====================================================
# 7. 结果展示
# ====================================================
fingerprint="random"
spiderx=""
if [[ $netstack == "6" ]]; then ip=[$ip]; fi
vless_reality_url="vless://${uuid}@${ip}:${port}?flow=xtls-rprx-vision&encryption=none&type=tcp&security=reality&sni=${domain}&fp=${fingerprint}&pbk=${public_key}&sid=${shortid}&spx=${spiderx}&#VLESS_R_${ip}"

echo -e "\n$green---------- Xray 配置信息 ----------$none"
echo -e "$yellow 地址: $cyan${ip}$none"
echo -e "$yellow 端口: $cyan${port}$none"
echo -e "$yellow UUID: $cyan${uuid}$none"
echo -e "$yellow 公钥: $cyan${public_key}$none"
echo -e "$yellow 私钥: $cyan${private_key}$none"
echo -e "$yellow URL: $cyan${vless_reality_url}$none"

qrencode -t UTF8 "$vless_reality_url"
echo "$vless_reality_url" > ~/_vless_rea
